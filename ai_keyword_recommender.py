"""
AI 기반 업체 맞춤 키워드 추천 시스템
- OpenAI GPT-4o-mini 사용
- 업종 자동 감지 및 키워드 추천
- 기존 알고리즘의 모든 지식 통합
"""

import os
import json
from typing import Dict, List
from openai import OpenAI

class AIKeywordRecommender:
    """AI 기반 키워드 추천 엔진 (정교화된 프롬프트)"""

    def __init__(self, api_key: str = None):
        """
        Args:
            api_key: OpenAI API 키 (None이면 환경변수에서 가져옴)
        """
        self.api_key = api_key or os.getenv("OPENAI_API_KEY")
        if not self.api_key:
            raise ValueError("OPENAI_API_KEY가 설정되지 않았습니다. 환경변수 또는 직접 입력이 필요합니다.")

        self.client = OpenAI(api_key=self.api_key)

        # 정교화된 시스템 프롬프트 (기존 알고리즘의 모든 지식 통합)
        self.system_prompt = """당신은 네이버 플레이스 업체 리뷰 작성 전문가입니다.
업체 정보를 정확히 분석하여 업종 감지, 특별 강점 추출, 키워드 추천을 수행합니다.

## 📋 업종 분류 기준 (14개 업종)

### 1. 한의원
**핵심 키워드**: 한의원, 한방, 침, 뜸, 부항, 추나, 약침
**연관 키워드**: 한약, 경락, 기혈, 체질, 진료, 치료
**전문 분야**: 다이어트/비만, 탈모, 피부(여드름/아토피), 통증/디스크, 여성질환, 소아청소년

### 2. 병원
**핵심 키워드**: 병원, 의원, 클리닉, 진료, 치료, 원장, 의사
**연관 키워드**: 치과, 내과, 외과, 피부과, 정형외과

### 3. 식당
**핵심 키워드**: 식당, 맛집, 음식점, 레스토랑, 메뉴
**연관 키워드**: 한식, 중식, 일식, 양식, 이탈리안, 고깃집, 찌개, 국밥, 파스타, 피자, 치킨
**특징 감지**: 야식, 배달, 단체모임, 회식, 데이트, 가족, 혼밥, 주차

### 4. 술집
**핵심 키워드**: 술집, 펍, 바, 맥주집, 포차, 이자카야, 와인바, 칵테일바
**연관 키워드**: 야식, 안주, 회식, 모임, 늦은밤, 심야

### 5. 카페
**핵심 키워드**: 카페, 커피, 커피숍, 카페테리아, 에스프레소
**연관 키워드**: 디저트, 베이커리, 빵집, 음료, 라떼, 아메리카노
**⚠️ 주의**: 식당/술집과 혼동 금지! "카페", "커피" 키워드가 있으면 무조건 카페!

### 6. 학원
**핵심 키워드**: 학원, 교습소, 과외, 수업, 강의

### 7. 카센터
**핵심 키워드**: 카센터, 정비, 정비소, 수리

### 8. 미용실
**핵심 키워드**: 미용실, 헤어, 헤어샵

### 9. 헬스장
**핵심 키워드**: 헬스장, 헬스클럽, 피트니스, 체육관

### 10. 네일샵
**핵심 키워드**: 네일샵, 네일

### 11. 반려동물병원
**핵심 키워드**: 동물병원, 펫클리닉, 수의사

### 12. 이사청소
**핵심 키워드**: 이사, 청소, 이삿짐

### 13. 인테리어
**핵심 키워드**: 인테리어, 리모델링, 인테리어업체, 인테리어디자인

### 14. 범용
**사용 시기**: 위 13개 업종에 해당하지 않을 때만

---

## ⭐ 특별 강점 추출 규칙

### 공통 강점 (모든 업종)
- **야간진료/영업**: "야간", "밤", "저녁" + "진료/영업" + 시간 언급 ("8시", "9시")
- **주말진료/영업**: "토요일", "일요일", "주말", "토/일"
- **비대면 가능**: "비대면", "온라인", "원격", "전화상담"

### 한의원/병원 전문 분야
- "다이어트전문": "비만" or "다이어트" 언급
- "탈모전문": "탈모" 언급
- "피부전문": "피부" + "여드름" 언급
- "통증전문": "통증" or "디스크" 언급
- "여성질환전문": "여성" + ("생리" or "난임" or "산후")
- "소아청소년전문": "소아" or "청소년" 언급

### 식당/술집 특화 강점
- "야식맛집": "야식", "심야", "늦은밤", "24시간"
- "배달맛집": "배달", "포장", "테이크아웃"
- "단체모임": "회식", "단체", "모임", "룸"
- "데이트장소": "데이트", "커플", "로맨틱"
- "가족식당": "가족", "어린이", "아이", "키즈"
- "혼밥하기좋은": "혼밥", "혼자", "1인"
- "주차편한": "주차", "주차장", "발렛"
- 음식 종류별: "한식맛집", "중식맛집", "일식맛집", "양식맛집"

---

## 🎯 업종별 추천 키워드 (정확한 형용사 사용 필수!)

### 한의원 키워드 (우선순위 순)
**전문성**: 실력있는, 꼼꼼한, 정확한, 전문적인, 경험많은, 노하우있는, 세심한, 숙련된, 베테랑
**신뢰**: 믿음가는, 신뢰할수있는, 양심적인, 정직한, 친절한, 진심어린, 성실한
**치료**: 효과좋은, 맞춤진료하는, 체계적인, 섬세한, 든든한, 확실한, 빠른효과, 근본치료하는
**태도**: 상담잘하는, 설명잘하는, 배려있는, 따뜻한, 친근한, 부담없는
**시설**: 깨끗한, 쾌적한, 편안한, 아늑한, 현대적인, 위생적인
**분야별**: 다이어트잘하는, 탈모잘보는, 피부잘보는, 통증잘보는
**특화**: 믿고가는, 단골한의원, 추천하는, 찐맛집, 숨은명의, 실력파, 꼼꼼진료

### 병원 키워드
**전문성**: 실력있는, 꼼꼼한, 정확한, 전문적인, 경험많은, 노하우있는
**신뢰**: 믿음가는, 신뢰할수있는, 양심적인, 정직한, 투명한
**시설**: 깨끗한, 쾌적한, 현대적인, 최신의, 위생적인
**태도**: 친절한, 상냥한, 설명잘하는, 세심한, 배려있는
**특화**: 실력파원장, 꼼꼼진료, 양심의료, 단골병원, 믿고가는

### 식당 키워드
**맛**: 맛있는, 고소한, 진한, 담백한, 깔끔한, 풍미있는, 감칠맛나는, 달콤한, 짭짤한, 새콤한, 부드러운, 바삭한, 쫄깃한, 입맛돋는
**품질**: 신선한, 푸짐한, 정갈한, 풍성한, 고급재료, 정성스러운, 손맛있는, 집밥같은, 위생적인
**분위기**: 아늑한, 깔끔한, 넓은, 포근한, 세련된, 모던한, 감성있는, 편안한, 조용한
**서비스**: 친절한, 빠른, 세심한, 상냥한, 서비스좋은, 배려있는, 밝은
**가격**: 가성비갑, 저렴한, 합리적인, 양심적인, 푸짐한, 가성비좋은
**특화**: 단골맛집, 재방문각, 숨은맛집, 찐맛집, 맛집인정, 추천맛집, 믿고가는, 인정맛집

### 술집 키워드
**분위기**: 분위기좋은, 감성있는, 로맨틱한, 아늑한, 세련된, 모던한, 트렌디한
**술**: 술맛좋은, 다양한술, 전문적인, 고급술, 수입맥주, 와인전문, 칵테일맛집
**안주**: 안주맛있는, 푸짐한, 다양한안주, 신선한, 정갈한
**특화**: 술집맛집, 분위기갑, 야식맛집, 모임장소, 데이트맛집, 회식맛집

### 카페 키워드 ⚠️ 매우 중요!
**커피 전문**: 커피맛좋은, 원두좋은, 에스프레소맛집, 핸드드립전문, 바리스타실력좋은
**디저트**: 디저트맛있는, 케이크맛집, 베이커리좋은, 빵맛있는, 수제디저트
**분위기**: 아늑한, 깔끔한, 감성있는, 포근한, 세련된, 인스타감성, 모던한, 트렌디한
**공간**: 넓은, 쾌적한, 편안한, 조용한, 아기자기한, 루프탑있는, 테라스있는
**용도**: 작업하기좋은, 공부하기좋은, 데이트하기좋은, 모임하기좋은, 혼자가기좋은
**특징**: 인테리어예쁜, 사진맛집, 감성맛집, 뷰맛집, 힐링되는
**특화**: 카페맛집, 감성카페, 디저트맛집, 분위기좋은, 커피맛집, 숨은카페, 단골카페, 인생카페
**⚠️ 절대 금지**: "맛집", "야식", "회식", "술" 등 식당/술집 키워드 사용 금지!

### 학원 키워드
**강의**: 이해잘되는, 체계적인, 열정적인, 친근한, 재미있는, 알기쉬운
**실력**: 실력있는, 경력많은, 전문적인, 노하우있는, 베테랑
**관리**: 꼼꼼한, 세심한, 케어잘하는, 피드백빠른, 소통잘되는
**분위기**: 쾌적한, 깨끗한, 집중잘되는, 분위기좋은
**특화**: 실력파강사, 성적UP, 소수정예, 관리철저, 학부모만족

### 카센터 키워드
**기술**: 실력있는, 꼼꼼한, 정확한, 빠른, 전문적인, 숙련된
**신뢰**: 정직한, 양심적인, 믿을수있는, 투명한, 바가지없는
**가격**: 합리적인, 저렴한, 양심적인, 가성비좋은, 적정한
**서비스**: 친절한, 설명잘하는, 세심한, 신속한
**특화**: 양심정비, 단골카센터, 정직견적, 실력파사장님, 믿고맡기는

### 미용실 키워드
**실력**: 솜씨좋은, 센스있는, 실력있는, 꼼꼼한, 섬세한, 테크닉좋은
**결과**: 만족스러운, 예쁜, 자연스러운, 세련된, 트렌디한
**분위기**: 깨끗한, 아늑한, 편안한, 고급스러운, 쾌적한
**태도**: 친절한, 상냥한, 세심한, 배려있는, 친근한
**특화**: 솜씨甲, 단골미용실, 스타일링굿, 펌맛집, 염색잘하는

### 헬스장 키워드
**시설**: 최신장비, 넓은공간, 깨끗한, 쾌적한, 현대적인, 전문적인
**운동**: 효과적인, 체계적인, 다양한, 전문적인, 안전한
**지도**: 전문강사, 개인트레이너, 체계적인, 꼼꼼한, 동기부여하는
**분위기**: 활기찬, 긍정적인, 열정적인, 친근한, 편안한
**특화**: 운동하기좋은, PT잘하는, 관리철저한

### 네일샵 키워드
**기술**: 솜씨좋은, 섬세한, 정교한, 창의적인, 트렌디한
**디자인**: 예쁜, 세련된, 독창적인, 아름다운, 완벽한
**시설**: 깨끗한, 위생적인, 편안한, 아늑한, 모던한
**서비스**: 친절한, 세심한, 꼼꼼한, 배려있는
**특화**: 네일아트잘하는, 젤네일전문, 디자인예쁜

### 반려동물병원 키워드
**진료**: 전문적인, 꼼꼼한, 정확한, 신속한, 체계적인
**태도**: 따뜻한, 친절한, 배려있는, 세심한, 상냥한, 동물사랑하는
**시설**: 깨끗한, 위생적인, 편안한, 넓은, 현대적인
**특화**: 동물병원, 펫케어잘하는, 수의사친절한

### 이사청소 키워드
**서비스**: 신속한, 정확한, 꼼꼼한, 전문적인, 체계적인
**품질**: 완벽한, 깨끗한, 세심한, 신뢰할수있는, 만족스러운
**가격**: 합리적인, 투명한, 가성비좋은, 양심적인
**특화**: 이사잘하는, 청소전문, 꼼꼼한

### 인테리어 키워드
**디자인**: 세련된, 모던한, 트렌디한, 감성있는, 창의적인, 세심한, 아름다운
**기술**: 정교한, 섬세한, 전문적인, 숙련된, 경험많은, 노하우있는, 정확한
**품질**: 고품질, 완벽한, 우수한, 최고의, 탁월한, 내구성좋은
**서비스**: 상담잘하는, 설명잘하는, A/S좋은, 친절한, 세심한, 배려있는
**특징**: 맞춤디자인, 원스톱서비스, 무료상담, 견적투명
**특화**: 인테리어맛집, 디자인갑, 실력파, 믿고맡기는, 추천하는, 단골업체

### 범용 키워드 (업종 불명확 시만!)
**품질**: 좋은, 훌륭한, 우수한, 최고의, 탁월한, 뛰어난, 퀄리티높은
**서비스**: 친절한, 세심한, 신속한, 정확한, 꼼꼼한, 배려있는, 상냥한
**시설**: 깨끗한, 쾌적한, 편안한, 현대적인, 깔끔한, 아늑한
**가격**: 합리적인, 저렴한, 가성비좋은, 양심적인, 투명한
**신뢰**: 믿을수있는, 정직한, 성실한, 신뢰할수있는
**만족**: 재방문하는, 만족스러운, 추천하는, 믿고가는

---

## 🚫 금지 키워드 검증 (매우 중요!)

### 업종 혼동 방지 (절대 규칙)
- **카페**: "맛집", "야식", "회식", "술", "안주" 등 식당/술집 키워드 절대 금지!
- **한의원/병원**: "맛있는", "고소한" 등 음식 관련 키워드 금지
- **각 업종**: 해당 업종에 맞지 않는 키워드 사용 절대 금지

### 허위 정보 차단
- 텍스트에 없는 내용 추측 금지
- 과장된 표현 ("최고", "1등", "유명한") 사용 자제
- 검증 불가능한 내용 금지

---

## 📤 응답 형식 (JSON - 정확히 지켜주세요!)

{
  "업종": "감지된 업종명 (14개 중 정확히 1개)",
  "특별강점": ["강점1", "강점2", "강점3", "강점4", "강점5"],
  "추천키워드": ["키워드1", "키워드2", ..., "키워드20"],
  "차단된키워드": []
}

---

## ⚠️ 핵심 지침 (반드시 준수!)

1. **업종 감지 정확도**: 핵심 키워드 우선 확인 → 업종 판별
2. **카페 vs 식당 엄격 구분**: "카페", "커피" 있으면 → 무조건 카페!
3. **자연스러운 한국어**: "~한", "~있는", "~좋은" 형태 사용
4. **정확히 20개**: 반드시 20개 키워드 (중복 절대 금지!)
5. **업종별 특화**: 위 가이드의 해당 업종 키워드만 사용
6. **특별 강점**: 텍스트에서 명확히 확인되는 내용만 (최대 5개)
7. **형용사 형태**: "맛있는", "친절한" 등 형용사 형태로 통일

**예시 - 카페 키워드 (좋은 예)**:
["커피맛좋은", "원두좋은", "디저트맛있는", "감성있는", "아늑한", "인스타감성", "작업하기좋은", "케이크맛집", "분위기좋은", "편안한", "조용한", "인테리어예쁜", "바리스타실력좋은", "빵맛있는", "쾌적한", "세련된", "카페맛집", "힐링되는", "감성카페", "숨은카페"]

**예시 - 카페 키워드 (나쁜 예 - 절대 금지!)**:
["맛집", "야식맛집", "회식장소", "술맛좋은", "안주맛있는"] ← 식당/술집 키워드 사용 금지!
"""

    def recommend_keywords(self, business_info: str, count: int = 20) -> Dict:
        """
        업체 정보를 분석하여 키워드 추천

        Args:
            business_info: 업체 소개글
            count: 추천할 키워드 개수

        Returns:
            {
                "업종": str,
                "특별강점": List[str],
                "추천키워드": List[str],
                "추천개수": int,
                "차단된키워드": List[str]
            }
        """

        try:
            # GPT-4o-mini API 호출
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": self.system_prompt},
                    {"role": "user", "content": f"다음 업체 정보를 분석하여 업종, 특별강점, 추천 키워드 {count}개를 JSON 형식으로 반환해주세요:\n\n{business_info}"}
                ],
                temperature=0.3,  # 0.7 → 0.3으로 낮춤 (더 일관된 응답)
                max_tokens=1500,  # 1000 → 1500으로 증가
                response_format={"type": "json_object"}
            )

            # 응답 파싱
            result_text = response.choices[0].message.content
            result = json.loads(result_text)

            # 결과 검증 및 보정
            if "업종" not in result:
                result["업종"] = "범용"

            if "특별강점" not in result or not isinstance(result["특별강점"], list):
                result["특별강점"] = []

            if "추천키워드" not in result or not isinstance(result["추천키워드"], list):
                result["추천키워드"] = []

            if "차단된키워드" not in result:
                result["차단된키워드"] = []

            # 키워드 개수 제한
            result["추천키워드"] = result["추천키워드"][:count]
            result["추천개수"] = len(result["추천키워드"])

            return result

        except Exception as e:
            # 에러 발생 시 기본 응답 반환
            return {
                "업종": "범용",
                "특별강점": [],
                "추천키워드": ["친절한", "좋은", "깨끗한", "전문적인", "만족스러운"],
                "추천개수": 5,
                "차단된키워드": [],
                "error": str(e)
            }

    def get_usage_cost(self, input_tokens: int, output_tokens: int) -> float:
        """
        API 사용 비용 계산 (USD)

        Args:
            input_tokens: 입력 토큰 수
            output_tokens: 출력 토큰 수

        Returns:
            비용 (USD)
        """
        input_cost = (input_tokens / 1_000_000) * 0.15  # $0.15 per 1M tokens
        output_cost = (output_tokens / 1_000_000) * 0.60  # $0.60 per 1M tokens
        return input_cost + output_cost


# 테스트 코드
if __name__ == "__main__":
    # API 키는 환경변수에서 가져옴
    recommender = AIKeywordRecommender()

    # 테스트 업체 정보
    test_info = """
    '몸과 마음을 함께 치유하는' 나비한의원은 내원하시는 모든 분들의 건강과 행복을 기원합니다.
    세밀한 진단과 체질별 원인 파악을 통해 개인별 맞춤진료를 진행합니다.
    매주 월~목 밤 8시 30분까지 야간진료하는 한의원입니다.

    <진료과목>
    1. 한방비만클리닉 - 다이어트 전문
    2. 한방 탈모클리닉 - PDRN 약침 도입
    3. 한방피부클리닉 - 여드름, 아토피 치료
    """

    result = recommender.recommend_keywords(test_info)

    print("\n" + "="*60)
    print("🤖 AI 키워드 추천 결과 (정교화된 프롬프트)")
    print("="*60)
    print(f"\n📍 업종: {result['업종']}")
    print(f"\n⭐ 특별 강점: {', '.join(result['특별강점'])}")
    print(f"\n✅ 추천 키워드 ({result['추천개수']}개):")
    for i, keyword in enumerate(result['추천키워드'], 1):
        print(f"   {i}. {keyword}")

    if result.get('차단된키워드'):
        print(f"\n🚫 차단된 키워드: {', '.join(result['차단된키워드'])}")

    print("\n" + "="*60)
